<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ферма Кристаллов</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .bg-miner {
            background: linear-gradient(135deg, #1f2937 0%, #0d0e12 100%);
        }
        .crystal-bounce:active {
            transform: scale(1.05);
            transition: transform 0.1s ease-out;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #3b82f6;
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #1f2937;
        }
    </style>
    <script>
        
        // --- Глобальное состояние игры (Начальные значения) ---
        const INITIAL_STATE = {
            crystals: 0,
            clickPower: 1, 
            drillCount: 0, 
            cps: 0,        
            upgrades: {}   
        };

        window.gameState = { ...INITIAL_STATE };

        window.gameData = {
            drillCost: 10,
            drillCps: 1,
            // Максимальный уровень (maxLevel) теперь используется для ограничения
            clickUpgrades: [
                { id: 'click1', name: 'Магнитный Адаптер', cost: 50, multiplier: 2, maxLevel: 5 },
                { id: 'click2', name: 'Лазерная Гравировка', cost: 500, multiplier: 3, maxLevel: 3 }
            ],
            cpsUpgrades: [
                { id: 'cps1', name: 'Система Охлаждения', cost: 100, multiplier: 1.5, maxLevel: 5 },
                { id: 'cps2', name: 'Квантовый Чип', cost: 1000, multiplier: 2, maxLevel: 3 }
            ]
        };
        
        const LOCAL_STORAGE_KEY = 'crystal_miner_save';
        
        // --- ФУНКЦИИ СОХРАНЕНИЯ/ЗАГРУЗКИ ---

        function loadGameState() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                try {
                    const loadedState = JSON.parse(savedData);
                    window.gameState = { ...INITIAL_STATE, ...loadedState };
                    console.log("Состояние игры загружено из LocalStorage.");
                } catch (e) {
                    console.error("Ошибка при парсинге данных LocalStorage:", e);
                    window.gameState = { ...INITIAL_STATE };
                }
            } else {
                 console.log("Локальное сохранение не найдено. Начинаем новую игру.");
            }

            recalculateStats();
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            updateUI();
        }

        window.saveGameState = function() {
            try {
                const dataToSave = {
                    crystals: window.gameState.crystals,
                    clickPower: window.gameState.clickPower,
                    drillCount: window.gameState.drillCount,
                    cps: window.gameState.cps,
                    upgrades: window.gameState.upgrades
                };
                
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (error) {
                console.error("Ошибка сохранения состояния игры в LocalStorage:", error);
            }
        }
        
        // --- ЛОГИКА ИГРЫ ---
        
        function recalculateStats() {
            // Пересчет Click Power
            let baseClickPower = 1;
            window.gameData.clickUpgrades.forEach(upgrade => {
                const level = window.gameState.upgrades[upgrade.id] || 0;
                baseClickPower += (upgrade.multiplier - 1) * level;
            });
            window.gameState.clickPower = Math.round(baseClickPower * 10) / 10; 

            // Пересчет CPS (Crystals Per Second)
            let baseCps = window.gameState.drillCount * window.gameData.drillCps;
            let cpsMultiplier = 1; 
            
            window.gameData.cpsUpgrades.forEach(upgrade => {
                const level = window.gameState.upgrades[upgrade.id] || 0;
                cpsMultiplier *= Math.pow(upgrade.multiplier, level);
            });
            
            window.gameState.cps = Math.round(baseCps * cpsMultiplier * 10) / 10; 
        }

        // Обновление UI
        function updateUI() {
            const crystals = Math.floor(window.gameState.crystals);
            document.getElementById('crystals-display').textContent = crystals.toLocaleString('ru-RU');
            document.getElementById('cps-display').textContent = window.gameState.cps.toFixed(1);
            document.getElementById('click-power-display').textContent = window.gameState.clickPower;
            document.getElementById('drill-count-display').textContent = window.gameState.drillCount;
            document.getElementById('drill-count-display-2').textContent = window.gameState.drillCount;
            
            const drillCost = Math.floor(window.gameData.drillCost * Math.pow(1.15, window.gameState.drillCount));
            document.getElementById('drill-cost').textContent = drillCost.toLocaleString('ru-RU');
            document.getElementById('buy-drill-btn').disabled = crystals < drillCost;
            
            updateUpgradesSection('click-upgrades-list', window.gameData.clickUpgrades);
            updateUpgradesSection('cps-upgrades-list', window.gameData.cpsUpgrades);
        }
        
        // ИЗМЕНЕНА: Логика отображения кнопки "Макс. Уровень"
        function updateUpgradesSection(containerId, upgrades) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 
            
            upgrades.forEach(upgrade => {
                const currentLevel = window.gameState.upgrades[upgrade.id] || 0;
                const isMaxLevel = currentLevel >= upgrade.maxLevel; // Проверка на максимальный уровень
                
                // Стоимость растет экспоненциально (base_cost * 2^level)
                const nextCost = Math.floor(upgrade.cost * Math.pow(2, currentLevel));
                
                // Кнопка недоступна, если кристаллов меньше или достигнут макс. уровень
                const isDisabled = window.gameState.crystals < nextCost || isMaxLevel; 
                const progress = (currentLevel / upgrade.maxLevel) * 100;

                // --- ЛОГИКА ИЗМЕНЕНИЯ КНОПКИ ---
                let buttonText;
                let buttonClass;

                if (isMaxLevel) {
                    buttonText = 'МАКС. УРОВЕНЬ';
                    buttonClass = 'bg-blue-900 text-blue-300 cursor-not-allowed'; // Новый стиль для макс. уровня
                } else {
                    buttonText = `Улучшить (${nextCost.toLocaleString('ru-RU')} Cr)`;
                    buttonClass = isDisabled 
                        ? 'bg-gray-500 text-gray-300 cursor-not-allowed' 
                        : 'bg-green-600 hover:bg-green-700 text-white';
                }
                // --- КОНЕЦ ЛОГИКИ ИЗМЕНЕНИЯ КНОПКИ ---

                const element = `
                    <div class="p-3 bg-gray-700 rounded-lg shadow-md mb-2 flex flex-col sm:flex-row justify-between items-center transition duration-300 hover:bg-gray-600">
                        <div class="text-left w-full sm:w-2/3">
                            <p class="text-white font-bold">${upgrade.name}</p>
                            <p class="text-sm text-gray-400">Ур. ${currentLevel} / ${upgrade.maxLevel} (x${upgrade.multiplier} эффект)</p>
                            <div class="h-1 mt-1 bg-gray-500 rounded">
                                <div style="width: ${progress}%;" class="h-full ${isMaxLevel ? 'bg-blue-300' : 'bg-blue-500'} rounded"></div>
                            </div>
                        </div>
                        <button id="upgrade-${upgrade.id}" 
                                class="mt-2 sm:mt-0 px-4 py-2 text-sm font-semibold rounded-lg transition duration-150 ${buttonClass}"
                                onclick="buyUpgrade('${upgrade.id}')"
                                ${isDisabled ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
                container.innerHTML += element;
            });
        }

        window.manualClick = function() {
            const amount = window.gameState.clickPower;
            window.gameState.crystals += amount;
            updateUI();
            
            // Визуальный эффект
            const crystalEl = document.getElementById('crystal-button');
            const popup = document.createElement('div');
            popup.textContent = `+${amount}`;
            popup.className = 'absolute text-yellow-300 font-extrabold text-2xl pointer-events-none transition-all duration-500 ease-out opacity-0';
            popup.style.left = `${Math.random() * 80 + 10}%`;
            popup.style.top = `${Math.random() * 80 + 10}%`;
            crystalEl.appendChild(popup);
            
            setTimeout(() => {
                popup.style.transform = 'translateY(-50px)';
                popup.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                popup.remove();
            }, 500);
        }

        window.buyDrill = function() {
            const drillCost = Math.floor(window.gameData.drillCost * Math.pow(1.15, window.gameState.drillCount));
            if (window.gameState.crystals >= drillCost) {
                window.gameState.crystals -= drillCost;
                window.gameState.drillCount += 1;
                recalculateStats(); 
                updateUI();
                window.saveGameState(); 
            }
        }
        
        // ИЗМЕНЕНА: Проверка на максимальный уровень
        window.buyUpgrade = function(upgradeId) {
            let upgrade;
            
            upgrade = window.gameData.clickUpgrades.find(u => u.id === upgradeId);
            if (!upgrade) {
                upgrade = window.gameData.cpsUpgrades.find(u => u.id === upgradeId);
            }

            if (!upgrade) return;

            const currentLevel = window.gameState.upgrades[upgradeId] || 0;
            
            // --- ПРОВЕРКА НА МАКСИМАЛЬНЫЙ УРОВЕНЬ ---
            if (currentLevel >= upgrade.maxLevel) return;
            // --- КОНЕЦ ПРОВЕРКИ ---

            const cost = Math.floor(upgrade.cost * Math.pow(2, currentLevel));
            
            if (window.gameState.crystals >= cost) {
                window.gameState.crystals -= cost;
                window.gameState.upgrades[upgradeId] = currentLevel + 1;
                
                recalculateStats(); 
                updateUI();
                window.saveGameState(); 
            }
        }
        
        // --- ОСНОВНОЙ ЦИКЛ ИГРЫ ---
        function gameLoop() {
            if (window.gameState.cps > 0) {
                window.gameState.crystals += window.gameState.cps / 5; 
            }
            
            if (Date.now() % 5000 < 200) { 
                window.saveGameState();
            }

            updateUI();
        }

        // Запуск инициализации и цикла игры
        window.onload = function() {
            loadGameState();
            setInterval(gameLoop, 200); 
        };
        
        // Добавляем обработчик на случай закрытия для последнего сохранения
        window.addEventListener('beforeunload', () => {
             window.saveGameState();
        });

    </script>
</head>

<body class="bg-miner text-gray-100 min-h-screen">

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="text-center mb-6">
            <h1 class="4xl font-extrabold text-blue-400">Ферма Кристаллов 💎</h1>
            <p class="text-sm text-gray-400 mt-1">Кликер-фармилка с локальным сохранением</p>
            <p id="user-id" class="text-xs text-gray-500 mt-1">Прогресс сохраняется в браузере (LocalStorage)</p>
        </header>

        <div id="loading-state" class="text-center p-10 bg-gray-800 rounded-xl shadow-lg">
            <p class="text-lg text-blue-400 animate-pulse">Загрузка локальных данных...</p>
        </div>

        <div id="game-container" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-xl flex flex-col items-center">
                <h2 class="text-2xl font-bold mb-4 text-center text-yellow-300">Статистика</h2>

                <div class="w-full text-center mb-6 p-4 bg-gray-700 rounded-lg">
                    <p class="text-xl text-gray-400">Кристаллы (Cr):</p>
                    <p id="crystals-display" class="text-5xl font-black text-white mt-1">0</p>
                    <p class="text-sm text-green-400 mt-2">
                        +<span id="cps-display">0.0</span>/сек | Клик: <span id="click-power-display">1</span>
                    </p>
                </div>

                <button id="crystal-button" 
                        onclick="manualClick()" 
                        class="relative w-48 h-48 bg-purple-700 rounded-full shadow-2xl flex items-center justify-center crystal-bounce transition duration-150 overflow-hidden border-4 border-purple-400">
                    <span class="text-8xl" aria-label="Crystal Emoji">💎</span>
                </button>
                <p class="text-gray-400 mt-4">Нажмите на кристалл, чтобы добывать!</p>

                <div class="mt-6 w-full text-center p-3 bg-gray-700 rounded-lg">
                    <p class="text-lg text-gray-300">Автоматические буры:</p>
                    <p id="drill-count-display" class="3xl font-bold text-blue-300">0</p>
                </div>
            </div>

            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-xl custom-scroll overflow-y-auto max-h-[80vh]">
                <h2 class="text-2xl font-bold mb-4 text-center text-green-400">Магазин Улучшений</h2>

                <div class="mb-6 border-b border-gray-700 pb-4">
                    <h3 class="text-xl font-semibold text-blue-300 mb-3">Автоматическая Добыча</h3>
                    <div class="p-4 bg-gray-700 rounded-lg shadow-md flex justify-between items-center">
                        <div>
                            <p class="text-white font-bold">Установка Бура (дает +1.0 CPS)</p>
                            <p class="text-sm text-gray-400">Кол-во: <span id="drill-count-display-2">0</span></p>
                        </div>
                        <button id="buy-drill-btn" 
                                onclick="buyDrill()" 
                                class="px-4 py-2 text-sm font-semibold rounded-lg transition duration-150 bg-yellow-600 hover:bg-yellow-700 text-white disabled:bg-gray-500 disabled:text-gray-300 disabled:cursor-not-allowed">
                            Купить (<span id="drill-cost">10</span> Cr)
                        </button>
                    </div>
                </div>

                <div class="mb-6 border-b border-gray-700 pb-4">
                    <h3 class="text-xl font-semibold text-blue-300 mb-3">Улучшения Кликера (x Клик)</h3>
                    <div id="click-upgrades-list">
                        </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-blue-300 mb-3">Улучшения CPS (x Автодобыча)</h3>
                    <div id="cps-upgrades-list">
                        </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
