<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–µ—Ä–º–∞ –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ç–∏–ª—å –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ —Ñ–æ–Ω–∞ */
        .bg-miner {
            background: linear-gradient(135deg, #1f2937 0%, #0d0e12 100%);
        }
        /* –ê–Ω–∏–º–∞—Ü–∏—è –∫–ª–∏–∫–∞ (–∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ) */
        .crystal-bounce:active {
            transform: scale(1.05);
            transition: transform 0.1s ease-out;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #3b82f6;
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #1f2937;
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        setLogLevel('debug');

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Firebase (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let currentUserId = null;
        let docRef = null;
        let isSaving = false;
        let isAuthReady = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        
        // --- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã ---
        window.gameState = {
            crystals: 0,
            clickPower: 1, // –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –∑–∞ –∫–ª–∏–∫
            drillCount: 0, // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—É—Ä–æ–≤
            cps: 0,        // –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
            upgrades: {}   // –ö—É–ø–ª–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
        };

        window.gameData = {
            // –°—Ç–æ–∏–º–æ—Å—Ç—å –±—É—Ä–æ–≤ (–∞–≤—Ç–æ–¥–æ–±—ã—á–∞)
            drillCost: 10,
            drillCps: 1,
            // –£–ª—É—á—à–µ–Ω–∏—è –∫–ª–∏–∫–∞
            clickUpgrades: [
                { id: 'click1', name: '–ú–∞–≥–Ω–∏—Ç–Ω—ã–π –ê–¥–∞–ø—Ç–µ—Ä', cost: 50, multiplier: 2, currentLevel: 0, maxLevel: 5 },
                { id: 'click2', name: '–õ–∞–∑–µ—Ä–Ω–∞—è –ì—Ä–∞–≤–∏—Ä–æ–≤–∫–∞', cost: 500, multiplier: 3, currentLevel: 0, maxLevel: 3 }
            ],
            // –£–ª—É—á—à–µ–Ω–∏—è CPS (–±—É—Ä–æ–≤)
            cpsUpgrades: [
                { id: 'cps1', name: '–°–∏—Å—Ç–µ–º–∞ –û—Ö–ª–∞–∂–¥–µ–Ω–∏—è', cost: 100, multiplier: 1.5, currentLevel: 0, maxLevel: 5 },
                { id: 'cps2', name: '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ß–∏–ø', cost: 1000, multiplier: 2, currentLevel: 0, maxLevel: 3 }
            ]
        };
        
        // --- –§–£–ù–ö–¶–ò–ò FIREBASE ---

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserSessionPersistence);

                // –û–∂–∏–¥–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                onAuthStateChanged(auth, (user) => {
                    if (!isAuthReady) { // –ó–∞–ø—É—Å–∫–∞–µ–º –ª–æ–≥–∏–∫—É —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
                        
                        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ú—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π UID. –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç,
                        // –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å Firestore –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã –∏–∑-–∑–∞ –ø—Ä–∞–≤–∏–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
                        if (user && user.uid) {
                            currentUserId = user.uid;
                        } else {
                            console.error("Firebase: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å UID. –û–ø–µ—Ä–∞—Ü–∏–∏ Firestore –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã.");
                            document.getElementById('loading-state').textContent = '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é.';
                            return; // –û–°–¢–ê–ù–û–í–ö–ê, –µ—Å–ª–∏ UID –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                        }

                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç
                        // –ü—É—Ç—å: /artifacts/{appId}/users/{userId}/game_state/miner_progress
                        docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'game_state', 'miner_progress');
                        
                        console.log(`Firebase: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${currentUserId}`);
                        document.getElementById('user-id').textContent = `ID: ${currentUserId.substring(0, 8)}...`;
                        
                        isAuthReady = true;
                        startSnapshotListener();
                    }
                });

                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–æ–∫–µ–Ω, –∑–∞—Ç–µ–º –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase –∏–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", error);
                document.getElementById('loading-state').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–º. –∫–æ–Ω—Å–æ–ª—å).';
            }
        }

        function startSnapshotListener() {
            if (!docRef || !isAuthReady) return;
            
            // onSnapshot –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            onSnapshot(docRef, (docSnap) => {
                // –ï—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –≥–æ—Ç–æ–≤–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É
                if (!isAuthReady) return; 

                if (docSnap.exists()) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    const loadedState = docSnap.data();
                    window.gameState = { ...window.gameState, ...loadedState };
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —É–ª—É—á—à–µ–Ω–∏—è, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å clickPower –∏ cps
                    recalculateStats();
                    console.log("–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ Firestore.");
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('game-container').classList.remove('hidden');
                } else {
                    // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    console.log("–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.");
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –±—ã–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                    if (window.gameState.crystals === 0 && Object.keys(window.gameState.upgrades).length === 0) {
                        saveGameState();
                    }
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('game-container').classList.remove('hidden');
                }
                updateUI();
            }, (error) => {
                // –í—ã–≤–æ–¥ –æ—à–∏–±–∫–∏ "Missing or insufficient permissions"
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö Firestore:", error);
                document.getElementById('loading-state').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏.';
            });
        }

        window.saveGameState = async function() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ Firebase –≥–æ—Ç–æ–≤–∞ –∏ –µ—Å—Ç—å docRef
            if (!docRef || isSaving || !isAuthReady) return;
            
            isSaving = true;
            try {
                // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—è
                const dataToSave = {
                    crystals: window.gameState.crystals,
                    clickPower: window.gameState.clickPower,
                    drillCount: window.gameState.drillCount,
                    cps: window.gameState.cps,
                    upgrades: window.gameState.upgrades
                };
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º setDoc —Å merge: true, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å, –∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å
                await setDoc(docRef, dataToSave, { merge: true });
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã:", error);
                // –û—à–∏–±–∫–∞ "Missing or insufficient permissions"
            } finally {
                isSaving = false;
            }
        }
        
        // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---
        
        // –û–±–Ω–æ–≤–ª—è–µ—Ç clickPower –∏ cps –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π
        function recalculateStats() {
            // –ü–µ—Ä–µ—Å—á–µ—Ç Click Power
            let baseClickPower = 1;
            window.gameData.clickUpgrades.forEach(upgrade => {
                const level = window.gameState.upgrades[upgrade.id] || 0;
                // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –∫–ª–∏–∫–∞ –¥–µ–ª–∞–µ—Ç –∫–ª–∏–∫ —Å–∏–ª—å–Ω–µ–µ –≤ (multiplier) —Ä–∞–∑ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
                // baseClickPower = 1 (base) + (2-1)*level_1 + (3-1)*level_2
                baseClickPower += (upgrade.multiplier - 1) * level;
            });
            window.gameState.clickPower = Math.round(baseClickPower * 10) / 10; // –û–∫—Ä—É–≥–ª—è–µ–º –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã

            // –ü–µ—Ä–µ—Å—á–µ—Ç CPS (Crystals Per Second)
            let baseCps = window.gameState.drillCount * window.gameData.drillCps;
            let cpsMultiplier = 1; // –û–±—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å CPS
            
            window.gameData.cpsUpgrades.forEach(upgrade => {
                const level = window.gameState.upgrades[upgrade.id] || 0;
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ú–ù–û–ñ–ò–¢–ï–õ–¨ (1.5, 2 –∏ —Ç.–¥.) –∑–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å
                cpsMultiplier *= Math.pow(upgrade.multiplier, level);
            });
            
            // –ò—Ç–æ–≥–æ–≤—ã–π CPS = (–ë–∞–∑–æ–≤—ã–π CPS –æ—Ç –±—É—Ä–æ–≤) * (–û–±—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å)
            window.gameState.cps = Math.round(baseCps * cpsMultiplier * 10) / 10; 
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        function updateUI() {
            const crystals = Math.floor(window.gameState.crystals);
            document.getElementById('crystals-display').textContent = crystals.toLocaleString('ru-RU');
            document.getElementById('cps-display').textContent = window.gameState.cps.toFixed(1);
            document.getElementById('click-power-display').textContent = window.gameState.clickPower;
            document.getElementById('drill-count-display').textContent = window.gameState.drillCount;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –≤ –º–∞–≥–∞–∑–∏–Ω–µ (–±—É—Ä—ã)
            const drillCost = Math.floor(window.gameData.drillCost * Math.pow(1.15, window.gameState.drillCount));
            document.getElementById('drill-cost').textContent = drillCost.toLocaleString('ru-RU');
            document.getElementById('buy-drill-btn').disabled = crystals < drillCost;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ —É–ª—É—á—à–µ–Ω–∏–π
            updateUpgradesSection('click-upgrades-list', window.gameData.clickUpgrades);
            updateUpgradesSection('cps-upgrades-list', window.gameData.cpsUpgrades);
        }
        
        function updateUpgradesSection(containerId, upgrades) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞
            
            upgrades.forEach(upgrade => {
                const currentLevel = window.gameState.upgrades[upgrade.id] || 0;
                // –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å—Ç–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ (base_cost * 2^level)
                const nextCost = Math.floor(upgrade.cost * Math.pow(2, currentLevel));
                const isDisabled = window.gameState.crystals < nextCost || currentLevel >= upgrade.maxLevel;
                const progress = (currentLevel / upgrade.maxLevel) * 100;

                const buttonText = currentLevel < upgrade.maxLevel 
                    ? `–£–ª—É—á—à–∏—Ç—å (${nextCost.toLocaleString('ru-RU')} Cr)`
                    : '–ú–∞–∫—Å. –£—Ä–æ–≤–µ–Ω—å';
                
                const element = `
                    <div class="p-3 bg-gray-700 rounded-lg shadow-md mb-2 flex flex-col sm:flex-row justify-between items-center transition duration-300 hover:bg-gray-600">
                        <div class="text-left w-full sm:w-2/3">
                            <p class="text-white font-bold">${upgrade.name}</p>
                            <p class="text-sm text-gray-400">–£—Ä. ${currentLevel} / ${upgrade.maxLevel} (x${upgrade.multiplier} —ç—Ñ—Ñ–µ–∫—Ç)</p>
                            <div class="h-1 mt-1 bg-gray-500 rounded">
                                <div style="width: ${progress}%;" class="h-full bg-blue-500 rounded"></div>
                            </div>
                        </div>
                        <button id="upgrade-${upgrade.id}" 
                                class="mt-2 sm:mt-0 px-4 py-2 text-sm font-semibold rounded-lg transition duration-150 ${isDisabled ? 'bg-gray-500 text-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'}"
                                onclick="buyUpgrade('${upgrade.id}')"
                                ${isDisabled ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
                container.innerHTML += element;
            });
        }

        window.manualClick = function() {
            const amount = window.gameState.clickPower;
            window.gameState.crystals += amount;
            updateUI();
            
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
            const crystalEl = document.getElementById('crystal-button');
            const popup = document.createElement('div');
            popup.textContent = `+${amount}`;
            popup.className = 'absolute text-yellow-300 font-extrabold text-2xl pointer-events-none transition-all duration-500 ease-out opacity-0';
            popup.style.left = `${Math.random() * 80 + 10}%`;
            popup.style.top = `${Math.random() * 80 + 10}%`;
            crystalEl.appendChild(popup);
            
            // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                popup.style.transform = 'translateY(-50px)';
                popup.style.opacity = '1';
            }, 10);
            
            // –£–¥–∞–ª–µ–Ω–∏–µ
            setTimeout(() => {
                popup.remove();
            }, 500);
        }

        window.buyDrill = function() {
            const drillCost = Math.floor(window.gameData.drillCost * Math.pow(1.15, window.gameState.drillCount));
            if (window.gameState.crystals >= drillCost) {
                window.gameState.crystals -= drillCost;
                window.gameState.drillCount += 1;
                recalculateStats(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º CPS, —Ç–∞–∫ –∫–∞–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É—Ä–æ–≤ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                updateUI();
                window.saveGameState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏
            }
        }

        window.buyUpgrade = function(upgradeId) {
            let upgrade;
            
            // –ò—â–µ–º —É–ª—É—á—à–µ–Ω–∏–µ –≤ –æ–±–æ–∏—Ö —Å–ø–∏—Å–∫–∞—Ö
            upgrade = window.gameData.clickUpgrades.find(u => u.id === upgradeId);
            if (!upgrade) {
                upgrade = window.gameData.cpsUpgrades.find(u => u.id === upgradeId);
            }

            if (!upgrade) return;

            const currentLevel = window.gameState.upgrades[upgradeId] || 0;
            if (currentLevel >= upgrade.maxLevel) return;

            const cost = Math.floor(upgrade.cost * Math.pow(2, currentLevel));
            
            if (window.gameState.crystals >= cost) {
                window.gameState.crystals -= cost;
                window.gameState.upgrades[upgradeId] = currentLevel + 1;
                
                recalculateStats(); // –û–±–Ω–æ–≤–ª—è–µ–º clickPower –∏–ª–∏ CPS
                updateUI();
                window.saveGameState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏
            }
        }
        
        // --- –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ –ò–ì–†–´ ---
        function gameLoop() {
            // 1. –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ (Idle)
            if (window.gameState.cps > 0) {
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ CPS –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞, 
                // –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.
                window.gameState.crystals += window.gameState.cps / 5; // –î–µ–ª–∏–º –Ω–∞ 5, —Ç–∞–∫ –∫–∞–∫ —Ü–∏–∫–ª 5 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
            }
            
            // 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (—ç–∫–æ–Ω–æ–º–∏–º –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É)
            if (isAuthReady && Date.now() % 5000 < 200) { // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–µ ~5 —Å–µ–∫—É–Ω–¥, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞
                window.saveGameState();
            }

            // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            updateUI();
        }

        // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Ü–∏–∫–ª–∞ –∏–≥—Ä—ã
        window.onload = function() {
            initFirebase();
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª 5 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É (–¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –ø–∞—Å—Å–∏–≤–Ω–æ–π –¥–æ–±—ã—á–∏)
            setInterval(gameLoop, 200); 
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Å–ª—É—á–∞–π –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        window.addEventListener('beforeunload', () => {
             // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
             window.saveGameState();
        });

    </script>
</head>

<body class="bg-miner text-gray-100 min-h-screen">

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        <header class="text-center mb-6">
            <h1 class="4xl font-extrabold text-blue-400">–§–µ—Ä–º–∞ –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ üíé</h1>
            <p class="text-sm text-gray-400 mt-1">–ö–ª–∏–∫–µ—Ä-—Ñ–∞—Ä–º–∏–ª–∫–∞ —Å –æ–±–ª–∞—á–Ω—ã–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º</p>
            <p id="user-id" class="text-xs text-gray-500 mt-1">–û–∂–∏–¥–∞–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</p>
        </header>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading-state" class="text-center p-10 bg-gray-800 rounded-xl shadow-lg">
            <p class="text-lg text-blue-400 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±–ª–∞–∫–∞...</p>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã (—Å–∫—Ä—ã—Ç –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö) -->
        <div id="game-container" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- –°—Ç–æ–ª–±–µ—Ü 1: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ö–ª–∏–∫–µ—Ä -->
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-xl flex flex-col items-center">
                <h2 class="text-2xl font-bold mb-4 text-center text-yellow-300">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

                <!-- –î–∏—Å–ø–ª–µ–π –≤–∞–ª—é—Ç—ã -->
                <div class="w-full text-center mb-6 p-4 bg-gray-700 rounded-lg">
                    <p class="text-xl text-gray-400">–ö—Ä–∏—Å—Ç–∞–ª–ª—ã (Cr):</p>
                    <p id="crystals-display" class="text-5xl font-black text-white mt-1">0</p>
                    <p class="text-sm text-green-400 mt-2">
                        +<span id="cps-display">0.0</span>/—Å–µ–∫ | –ö–ª–∏–∫: <span id="click-power-display">1</span>
                    </p>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –∫–ª–∏–∫–µ—Ä–∞ -->
                <button id="crystal-button" 
                        onclick="manualClick()" 
                        class="relative w-48 h-48 bg-purple-700 rounded-full shadow-2xl flex items-center justify-center crystal-bounce transition duration-150 overflow-hidden border-4 border-purple-400">
                    <span class="text-8xl" aria-label="Crystal Emoji">üíé</span>
                </button>
                <p class="text-gray-400 mt-4">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª, —á—Ç–æ–±—ã –¥–æ–±—ã–≤–∞—Ç—å!</p>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É—Ä–æ–≤ -->
                <div class="mt-6 w-full text-center p-3 bg-gray-700 rounded-lg">
                    <p class="text-lg text-gray-300">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—É—Ä—ã:</p>
                    <p id="drill-count-display" class="3xl font-bold text-blue-300">0</p>
                </div>
            </div>

            <!-- –°—Ç–æ–ª–±–µ—Ü 2 –∏ 3: –ú–∞–≥–∞–∑–∏–Ω -->
            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-xl">
                <h2 class="text-2xl font-bold mb-4 text-blue-400">–ú–∞–≥–∞–∑–∏–Ω –£–ª—É—á—à–µ–Ω–∏–π</h2>

                <!-- –°–µ–∫—Ü–∏—è: –ë—É—Ä—ã (Idle Machines) -->
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3 text-white border-b border-gray-700 pb-2">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ë—É—Ä—ã (–ë–∞–∑–∞ CPS)</h3>
                    <div class="p-3 bg-gray-700 rounded-lg shadow-md flex justify-between items-center">
                        <div class="text-left">
                            <p class="text-white font-bold">–ö—É–ø–∏—Ç—å –ë—É—Ä (–¥–∞–µ—Ç +1.0 Cr/—Å–µ–∫)</p>
                            <p class="text-sm text-gray-400">–ö–æ–ª-–≤–æ: <span id="drill-count-display-shop">0</span></p>
                        </div>
                        <button id="buy-drill-btn" 
                                onclick="buyDrill()" 
                                class="px-4 py-2 text-sm font-semibold rounded-lg transition duration-150 bg-yellow-600 hover:bg-yellow-700 text-white disabled:bg-gray-500 disabled:text-gray-300">
                            –¶–µ–Ω–∞: <span id="drill-cost">10</span> Cr
                        </button>
                    </div>
                </div>

                <!-- –°–µ–∫—Ü–∏—è: –ü—Ä–æ–∫–∞—á–∫–∏ (Click Multipliers) -->
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3 text-white border-b border-gray-700 pb-2">–£–ª—É—á—à–µ–Ω–∏—è –ö–ª–∏–∫–æ–≤ (–ú–Ω–æ–∂–∏—Ç–µ–ª—å Click Power)</h3>
                    <div id="click-upgrades-list" class="custom-scroll max-h-60 overflow-y-auto pr-2">
                        <!-- –ó–¥–µ—Å—å JS —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è –∫–ª–∏–∫–æ–≤ -->
                    </div>
                </div>
                
                <!-- –°–µ–∫—Ü–∏—è: –ü—Ä–æ–∫–∞—á–∫–∏ (CPS Multipliers) -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-white border-b border-gray-700 pb-2">–£–ª—É—á—à–µ–Ω–∏—è CPS (–ú–Ω–æ–∂–∏—Ç–µ–ª—å –ë—É—Ä–æ–≤)</h3>
                    <div id="cps-upgrades-list" class="custom-scroll max-h-60 overflow-y-auto pr-2">
                        <!-- –ó–¥–µ—Å—å JS —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è CPS -->
                    </div>
                </div>

            </div>

        </div>

    </div>

</body>
</html>
